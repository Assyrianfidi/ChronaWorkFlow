// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// User management
enum Role {
  OWNER
  ADMIN
  MANAGER
  ACCOUNTANT
  STAFF
  VIEWER
}

enum SubscriptionPlan {
  STARTER
  GROWTH
  ENTERPRISE
}

model User {
  id                String            @id @default(cuid())
  email             String            @unique
  password          String
  name              String
  companyName       String?
  role              Role              @default(STAFF)
  subscriptionPlan SubscriptionPlan  @default(STARTER)
  isActive          Boolean           @default(true)
  companyId         String?
  tokenVersion      Int               @default(0)
  lastLoginAt       DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  company           User?             @relation("CompanyUsers", fields: [companyId], references: [id])
  users             User[]            @relation("CompanyUsers")
  accounts          Account[]         @relation("Accounts")
  transactions      Transaction[]     @relation("Transactions")
  invoices          Invoice[]         @relation("Invoices")
  customers         Customer[]        @relation("Customers")
  subscriptions     Subscription[]    @relation("Subscriptions")
  billingInvoices   BillingInvoice[]  @relation("BillingInvoices")
  paymentMethods    PaymentMethod[]   @relation("PaymentMethods")
  aiConversations   AIConversation[]   @relation("AIConversations")
  aiAuthoredConversations AIConversation[] @relation("AIConversationUser")

  @@map("users")
}

// Chart of Accounts
enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

model Account {
  id          String      @id @default(cuid())
  code        String      @unique
  name        String
  type        AccountType
  description String?
  balance     Decimal     @default(0.00) @db.Decimal(15, 2)
  isActive    Boolean     @default(true)
  parentId    String?
  companyId   String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  parent      Account?    @relation("AccountHierarchy", fields: [parentId], references: [id])
  children    Account[]   @relation("AccountHierarchy")
  company     User        @relation("Accounts", fields: [companyId], references: [id])
  lines       TransactionLine[]

  @@map("accounts")
}

// Transactions
model Transaction {
  id          String   @id @default(cuid())
  date        DateTime
  description String
  companyId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  company     User              @relation("Transactions", fields: [companyId], references: [id])
  lines       TransactionLine[]

  @@map("transactions")
}

model TransactionLine {
  id            String  @id @default(cuid())
  debit         Decimal @default(0.00) @db.Decimal(15, 2)
  credit        Decimal @default(0.00) @db.Decimal(15, 2)
  transactionId String
  accountId     String
  createdAt     DateTime @default(now())

  // Relations
  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  account     Account     @relation(fields: [accountId], references: [id])

  @@map("transaction_lines")
}

// Customers
model Customer {
  id        String   @id @default(cuid())
  name      String
  email     String?  @unique
  phone     String?
  address   String?
  companyId String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company   User      @relation("Customers", fields: [companyId], references: [id])
  invoices  Invoice[] @relation("CustomerInvoices")

  @@map("customers")
}

// Invoicing
enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String        @unique
  issueDate     DateTime
  dueDate       DateTime
  status        InvoiceStatus  @default(DRAFT)
  subtotal      Decimal       @default(0.00) @db.Decimal(15, 2)
  taxAmount     Decimal       @default(0.00) @db.Decimal(15, 2)
  totalAmount   Decimal       @default(0.00) @db.Decimal(15, 2)
  paidAmount    Decimal       @default(0.00) @db.Decimal(15, 2)
  customerId    String
  companyId     String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  customer   Customer       @relation("CustomerInvoices", fields: [customerId], references: [id])
  company    User           @relation("Invoices", fields: [companyId], references: [id])
  lines      InvoiceLine[]

  @@map("invoices")
}

model InvoiceLine {
  id          String  @id @default(cuid())
  description String
  quantity    Decimal @default(0.00) @db.Decimal(10, 2)
  unitPrice   Decimal @default(0.00) @db.Decimal(15, 2)
  taxRate     Decimal @default(0.00) @db.Decimal(5, 2)
  amount      Decimal @default(0.00) @db.Decimal(15, 2)
  invoiceId   String
  createdAt   DateTime @default(now())

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_lines")
}

// Subscription Management
model Subscription {
  id              String           @id @default(cuid())
  planType        SubscriptionPlan
  status          String           @default("ACTIVE")
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd Boolean          @default(false)
  stripeCustomerId String?
  stripeSubscriptionId String?
  stripePriceId    String?
  stripeCheckoutSessionId String?
  companyId       String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  company User @relation("Subscriptions", fields: [companyId], references: [id])

  @@map("subscriptions")
}

// Billing
model BillingInvoice {
  id          String   @id @default(cuid())
  invoiceNumber String @unique
  amount      Decimal  @db.Decimal(15, 2)
  currency    String   @default("USD")
  status      String   @default("PENDING")
  dueDate     DateTime
  paidAt      DateTime?
  companyId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  company User @relation("BillingInvoices", fields: [companyId], references: [id])

  @@map("billing_invoices")
}

enum PaymentMethodType {
  CREDIT_CARD
  BANK_ACCOUNT
}

model PaymentMethod {
  id           String             @id @default(cuid())
  type         PaymentMethodType
  last4        String
  brand        String?
  expiryMonth  Int?
  expiryYear   Int?
  isDefault    Boolean            @default(false)
  isActive     Boolean            @default(true)
  companyId    String
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  // Relations
  company User @relation("PaymentMethods", fields: [companyId], references: [id])

  @@map("payment_methods")
}

// Audit Logs
model AuditLog {
  id        String   @id @default(cuid())
  action    String
  entity    String
  entityId  String?
  oldValues Json?
  newValues Json?
  userId    String
  companyId String
  createdAt DateTime @default(now())

  @@map("audit_logs")
}

// AI Assistant
model AIConversation {
  id        String   @id @default(cuid())
  title     String?
  companyId String
  userId    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company   User       @relation("AIConversations", fields: [companyId], references: [id])
  user      User?      @relation("AIConversationUser", fields: [userId], references: [id])
  messages  AIMessage[]

  @@index([companyId])
  @@index([userId])
  @@map("ai_conversations")
}

enum AIMessageRole {
  SYSTEM
  USER
  ASSISTANT
}

model AIMessage {
  id             String        @id @default(cuid())
  conversationId String
  role           AIMessageRole
  content        String
  metadata       Json?
  createdAt      DateTime      @default(now())

  // Relations
  conversation AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("ai_messages")
}

model StripeWebhookEvent {
  id          String   @id
  type        String
  createdAt   DateTime @default(now())
  processedAt DateTime?
  status      String   @default("RECEIVED")

  @@map("stripe_webhook_events")
}
