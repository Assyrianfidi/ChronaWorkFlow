name: E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run E2E tests daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  e2e:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        # Test across multiple browsers
        browser: [chromium, firefox, webkit]
        # Test across different user roles
        role: [owner, accountant, staff]
        exclude:
          # Skip staff role on webkit (Safari) for performance
          - browser: webkit
            role: staff
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify TypeScript lock
        run: npm run verify:type-lock

      - name: Run linting
        run: npm run lint

      - name: Run TypeScript checks
        run: npm run typecheck

      - name: Install Playwright browsers
        run: npx playwright install --with-deps
      
      - name: Start services
        run: |
          # Start PostgreSQL
          docker run -d --name accubooks-e2e-db \
            -e POSTGRES_PASSWORD=accubooks_e2e_password \
            -e POSTGRES_USER=accubooks_e2e \
            -e POSTGRES_DB=accubooks_e2e \
            -p 5433:5432 \
            postgres:15
          
          # Wait for database
          until docker exec accubooks-e2e-db pg_isready -U accubooks_e2e; do
            echo "Waiting for database..."
            sleep 1
          done
          
          # Run migrations
          npm run db:migrate
          
          # Seed test data
          npm run db:seed
      
      - name: Start application servers
        run: |
          # Start backend server
          npm run start:dev &
          BACKEND_PID=$!
          
          # Start frontend server
          cd client && npm run dev &
          FRONTEND_PID=$!
          
          # Wait for servers to be ready
          until curl -s http://localhost:3000/api/health > /dev/null; do
            echo "Waiting for backend..."
            sleep 1
          done
          
          until curl -s http://localhost:3001 > /dev/null; do
            echo "Waiting for frontend..."
            sleep 1
          done
          
          echo "Servers ready"
          echo $BACKEND_PID > backend.pid
          echo $FRONTEND_PID > frontend.pid
      
      - name: Run E2E tests
        env:
          NODE_ENV: test
          DATABASE_URL: postgres://accubooks_e2e:accubooks_e2e_password@localhost:5433/accubooks_e2e
          AUTH_MODE: mock
          FEATURE_FLAGS: all_on
          AI_MODE: stub
          PAYMENTS_MODE: stub
          TAX_MODE: stub
          EMAIL_MODE: mock
          STORAGE_MODE: local
          TZ: UTC
        run: |
          npx playwright test \
            --project=${{ matrix.browser }}-${{ matrix.role }} \
            --reporter=html \
            --reporter=json \
            --reporter=junit \
            --output-dir=e2e-results/${{ matrix.browser }}-${{ matrix.role }}
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-results-${{ matrix.browser }}-${{ matrix.role }}
          path: |
            e2e-results/${{ matrix.browser }}-${{ matrix.role }}/
            test-results/
            playwright-report/
      
      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ matrix.browser }}-${{ matrix.role }}
          path: playwright-report/
      
      - name: Upload videos
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: videos-${{ matrix.browser }}-${{ matrix.role }}
          path: e2e-results/${{ matrix.browser }}-${{ matrix.role }}/videos/
      
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: screenshots-${{ matrix.browser }}-${{ matrix.role }}
          path: e2e-results/${{ matrix.browser }}-${{ matrix.role }}/screenshots/
      
      - name: Upload traces
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: traces-${{ matrix.browser }}-${{ matrix.role }}
          path: e2e-results/${{ matrix.browser }}-${{ matrix.role }}/traces/
      
      - name: Stop services
        if: always()
        run: |
          # Stop servers
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) || true
          fi
          if [ -f frontend.pid ]; then
            kill $(cat frontend.pid) || true
          fi
          
          # Stop database
          docker stop accubooks-e2e-db || true
          docker rm accubooks-e2e-db || true
      
      - name: Performance Report
        if: always()
        run: |
          echo "## E2E Test Performance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Browser | Role | Tests | Passed | Failed | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|-------|--------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "e2e-results/${{ matrix.browser }}-${{ matrix.role }}/test-results.json" ]; then
            node -e "
              const results = JSON.parse(require('fs').readFileSync('e2e-results/${{ matrix.browser }}-${{ matrix.role }}/test-results.json', 'utf8'));
              const duration = Math.round(results.suites[0].specs.reduce((acc, spec) => acc + spec.tests.reduce((acc2, test) => acc2 + test.results[0].duration, 0), 0) / 1000);
              console.log(\`| \${{ matrix.browser }} | \${{ matrix.role }} | \${results.suites[0].specs.reduce((acc, spec) => acc + spec.tests.length, 0)} | \${results.suites[0].specs.reduce((acc, spec) => acc + spec.tests.filter(t => t.results[0].status === 'passed').length, 0)} | \${results.suites[0].specs.reduce((acc, spec) => acc + spec.tests.filter(t => t.results[0].status === 'failed').length, 0)} | \${duration}s |\`);
            " >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Visual Regression Report
        if: always()
        run: |
          echo "## Visual Regression Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Screenshots captured for failed tests:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "e2e-results/${{ matrix.browser }}-${{ matrix.role }}/screenshots" ]; then
            find e2e-results/${{ matrix.browser }}-${{ matrix.role }}/screenshots -name "*.png" | head -10 | while read file; do
              echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
            done
          fi

  # Performance Budget Validation
  performance:
    runs-on: ubuntu-latest
    needs: e2e
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify TypeScript lock
        run: npm run verify:type-lock

      - name: Run linting
        run: npm run lint

      - name: Run TypeScript checks
        run: npm run typecheck

      - name: Validate performance budgets
        run: |
          echo "## Performance Budget Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if any tests exceeded SLA budgets
          SLA_VIOLATIONS=0
          
          for result in e2e-results/*/test-results.json; do
            if [ -f "$result" ]; then
              node -e "
                const results = JSON.parse(require('fs').readFileSync('$result', 'utf8'));
                const violations = results.suites[0].specs.filter(spec => 
                  spec.tests.some(test => 
                    test.results[0].annotations && 
                    test.results[0].annotations.some(ann => 
                      ann.type === 'slow' && 
                      ann.description && 
                      ann.description.includes('SLA')
                    )
                  )
                );
                if (violations.length > 0) {
                  console.log('SLA violations found in:', '$result');
                  process.exit(1);
                }
              " || SLA_VIOLATIONS=$((SLA_VIOLATIONS + 1))
            fi
          done
          
          if [ $SLA_VIOLATIONS -eq 0 ]; then
            echo "✅ All performance budgets met" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ $SLA_VIOLATIONS test suites exceeded performance budgets" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # Security and Compliance Report
  security:
    runs-on: ubuntu-latest
    needs: e2e
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify TypeScript lock
        run: npm run verify:type-lock

      - name: Run linting
        run: npm run lint

      - name: Run TypeScript checks
        run: npm run typecheck

      - name: Generate Security Report
        run: |
          echo "## Security & Compliance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Role-Based Access Control" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Owner role: Full access verified" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Accountant role: Financial access verified" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Staff role: Limited access verified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Data Protection" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ No real payment processing" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ No real tax filings" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Mock AI and scheduling engines" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Isolated test database" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Audit Trail" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ All test artifacts preserved" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Screenshots and videos for failed tests" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Performance metrics tracked" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Role-based access logs maintained" >> $GITHUB_STEP_SUMMARY
