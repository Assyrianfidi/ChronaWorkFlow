# Production Alert Rules
# Phase 2: Monitoring Setup Implementation
# Date: February 1, 2026
# Purpose: Prometheus AlertManager rules

groups:
  - name: accubooks_critical_alerts
    interval: 30s
    rules:
      # P0 - CRITICAL ALERTS (Immediate Page)
      
      - alert: HighErrorRate
        expr: rate(http_requests_total{status_code=~"5.."}[5m]) > 0.01
        for: 5m
        labels:
          severity: critical
          priority: P0
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} over the last 5 minutes (threshold: 1%)"
          action: "Investigate immediately - potential system failure"
      
      - alert: DatabasePoolExhaustion
        expr: db_pool_utilization_percent > 90
        for: 5m
        labels:
          severity: critical
          priority: P0
        annotations:
          summary: "Database pool near exhaustion"
          description: "Pool utilization is {{ $value }}% (threshold: 90%)"
          action: "Scale database pool or investigate connection leaks"
      
      - alert: SystemUnreachable
        expr: up{job="accubooks"} == 0
        for: 3m
        labels:
          severity: critical
          priority: P0
        annotations:
          summary: "AccuBooks system unreachable"
          description: "System has been unreachable for 3 minutes"
          action: "Check system health immediately - potential downtime"
      
      - alert: SystemUnhealthy
        expr: system_health_status == 0
        for: 5m
        labels:
          severity: critical
          priority: P0
        annotations:
          summary: "System health check failing"
          description: "System health status is unhealthy"
          action: "Check /api/monitoring/health/detailed for component status"

  - name: accubooks_high_priority_alerts
    interval: 1m
    rules:
      # P1 - HIGH PRIORITY ALERTS (Urgent Response)
      
      - alert: HighLatency
        expr: histogram_quantile(0.95, rate(http_request_duration_ms_bucket[5m])) > 1000
        for: 5m
        labels:
          severity: high
          priority: P1
        annotations:
          summary: "High API latency detected"
          description: "p95 latency is {{ $value }}ms (threshold: 1000ms)"
          action: "Investigate performance bottlenecks"
      
      - alert: ForecastQueueDepthHigh
        expr: forecast_queue_depth > 200
        for: 10m
        labels:
          severity: high
          priority: P1
        annotations:
          summary: "Forecast queue depth high"
          description: "Queue depth is {{ $value }} jobs (threshold: 200)"
          action: "Consider scaling forecast workers"
      
      - alert: CacheHitRateLow
        expr: cache_hit_rate_percent < 70
        for: 10m
        labels:
          severity: high
          priority: P1
        annotations:
          summary: "Cache hit rate low"
          description: "Cache hit rate is {{ $value }}% (threshold: 70%)"
          action: "Investigate cache effectiveness or increase cache size"
      
      - alert: DatabaseConnectionErrors
        expr: rate(db_connection_errors_total[5m]) > 5
        for: 5m
        labels:
          severity: high
          priority: P1
        annotations:
          summary: "Database connection errors detected"
          description: "{{ $value }} connection errors per minute"
          action: "Check database health and connection pool configuration"

  - name: accubooks_warning_alerts
    interval: 2m
    rules:
      # P2 - WARNING ALERTS (Monitor)
      
      - alert: DatabasePoolUtilizationWarning
        expr: db_pool_utilization_percent > 70
        for: 10m
        labels:
          severity: warning
          priority: P2
        annotations:
          summary: "Database pool utilization elevated"
          description: "Pool utilization is {{ $value }}% (threshold: 70%)"
          action: "Monitor closely - may need scaling soon"
      
      - alert: RedisMemoryWarning
        expr: cache_memory_usage_percent > 85
        for: 10m
        labels:
          severity: warning
          priority: P2
        annotations:
          summary: "Redis memory usage high"
          description: "Memory usage is {{ $value }}% (threshold: 85%)"
          action: "Monitor eviction rate - may need cache scaling"
      
      - alert: LatencyTrendDegradation
        expr: |
          (
            histogram_quantile(0.95, rate(http_request_duration_ms_bucket[1h]))
            /
            histogram_quantile(0.95, rate(http_request_duration_ms_bucket[24h]))
          ) > 1.5
        for: 30m
        labels:
          severity: warning
          priority: P2
        annotations:
          summary: "Latency trend degrading"
          description: "Current p95 latency is 50% higher than 24h average"
          action: "Investigate performance trends"
      
      - alert: ForecastJobFailureRateElevated
        expr: forecast_job_failure_rate_percent > 5
        for: 15m
        labels:
          severity: warning
          priority: P2
        annotations:
          summary: "Forecast job failure rate elevated"
          description: "Job failure rate is {{ $value }}% (threshold: 5%)"
          action: "Investigate forecast job errors"

  - name: accubooks_business_alerts
    interval: 5m
    rules:
      # Business Metric Alerts
      
      - alert: TierLimitHitsHigh
        expr: rate(tier_limit_hits_total[1h]) > 50
        for: 30m
        labels:
          severity: info
          priority: P3
        annotations:
          summary: "High tier limit hits detected"
          description: "{{ $value }} tier limit hits per hour"
          action: "Users may be hitting tier limits - consider upgrade prompts"
      
      - alert: NoActiveUsers
        expr: active_users_concurrent == 0
        for: 1h
        labels:
          severity: info
          priority: P3
        annotations:
          summary: "No active users detected"
          description: "Zero active users for 1 hour"
          action: "Verify system is accessible or expected downtime"
