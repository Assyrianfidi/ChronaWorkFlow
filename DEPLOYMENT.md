# AccuBooks Production Deployment Guide

This document provides a comprehensive guide to deploying AccuBooks in a production environment using Docker Compose.

## Prerequisites

- Docker 20.10+ and Docker Compose 1.29+
- A domain name (e.g., accubooks.example.com)
- SSL certificates (can be obtained automatically with Let's Encrypt)
- Basic knowledge of Linux server administration

## Directory Structure

```
.
├── .env                   # Environment variables (generated by generate-secrets.sh)
├── docker-compose.prod.yml # Production Docker Compose configuration
├── Dockerfile.prod        # Production Dockerfile
├── nginx/                 # Nginx configuration
│   ├── nginx.conf
│   └── conf.d/
│       └── accubooks.conf
├── certs/                 # SSL certificates (auto-created)
├── backups/               # Database backups
└── scripts/               # Utility scripts
    └── generate-secrets.sh
```

## Initial Setup

1. **Clone the repository**
   ```bash
   git clone https://github.com/yourusername/accubooks.git
   cd accubooks
   ```

2. **Generate environment variables**
   ```bash
   chmod +x scripts/generate-secrets.sh
   ./scripts/generate-secrets.sh
   ```

3. **Edit the .env file**
   Update the following variables in the generated `.env` file:
   ```env
   # Required
   DOMAIN=yourdomain.com
   EMAIL=your-email@example.com
   
   # Database
   DB_PASSWORD=your_secure_db_password
   
   # Redis
   REDIS_PASSWORD=your_secure_redis_password
   
   # OAuth Providers (optional)
   GOOGLE_CLIENT_ID=your_google_client_id
   GOOGLE_CLIENT_SECRET=your_google_client_secret
   GITHUB_CLIENT_ID=your_github_client_id
   GITHUB_CLIENT_SECRET=your_github_client_secret
   
   # SMTP Configuration (required for email notifications)
   SMTP_HOST=smtp.example.com
   SMTP_PORT=587
   SMTP_USER=your_smtp_username
   SMTP_PASSWORD=your_smtp_password
   SMTP_FROM=noreply@yourdomain.com
   ```

## Deployment

1. **Start the application**
   ```bash
   chmod +x deploy.sh
   ./deploy.sh up
   ```

2. **Obtain SSL certificates** (first time only)
   ```bash
   # Stop nginx temporarily
   docker-compose -f docker-compose.prod.yml stop nginx
   
   # Run certbot to obtain certificates
   docker run --rm \
     -p 80:80 \
     -v $(pwd)/certs:/etc/letsencrypt \
     -v $(pwd)/certs/www:/var/www/certbot \
     certbot/certbot certonly \
     --standalone \
     --preferred-challenges http \
     --email your-email@example.com \
     --agree-tos \
     --no-eff-email \
     -d accubooks.example.com \
     --non-interactive \
     --force-renewal
   
   # Restart nginx
   ./deploy.sh restart
   ```

3. **Verify the deployment**
   - Visit `https://yourdomain.com` in your browser
   - You should see the AccuBooks login page
   - Log in with the default admin credentials:
     - Email: admin@accubooks.com
     - Password: password

## Maintenance

### Common Tasks

- **View logs**: `./deploy.sh logs`
- **Restart services**: `./deploy.sh restart`
- **Stop services**: `./deploy.sh down`

### Database Backups

1. **Create a backup**
   ```bash
   ./deploy.sh db:backup
   ```
   This will create a timestamped SQL dump in the `backups/` directory.

2. **Restore from backup**
   ```bash
   ./deploy.sh db:restore
   ```
   This will prompt you to confirm before restoring from the latest backup.

### SSL Certificate Renewal

Certificates are automatically renewed by the certbot container. Manual renewal can be triggered with:

```bash
./deploy.sh cert:renew
```

## Monitoring and Logs

### Accessing Logs

- **Application logs**: `docker-compose -f docker-compose.prod.yml logs -f app`
- **Database logs**: `docker-compose -f docker-compose.prod.yml logs -f postgres`
- **Nginx logs**: `docker-compose -f docker-compose.prod.yml logs -f nginx`

### Health Checks

The application includes a health check endpoint at `https://yourdomain.com/health` that returns a 200 status when the application is running correctly.

## Scaling

To scale the application for higher traffic, you can increase the number of application containers:

```bash
docker-compose -f docker-compose.prod.yml up -d --scale app=3
```

## Security Considerations

1. **Firewall Configuration**
   - Only expose ports 80 and 443 to the internet
   - Restrict database access to the application containers only

2. **Regular Updates**
   - Regularly update the base images in `Dockerfile.prod`
   - Monitor for security advisories for all dependencies

3. **Backup Strategy**
   - Regularly back up the database using the provided script
   - Store backups in a secure, off-site location
   - Test restoration procedures periodically

## Troubleshooting

### Common Issues

1. **Port conflicts**
   - Ensure ports 80 and 443 are not in use by other services
   - Use `netstat -tuln | grep -E ':80|:443'` to check

2. **Certificate issues**
   - Check certbot logs: `docker-compose -f docker-compose.prod.yml logs certbot`
   - Ensure your domain's DNS is properly configured

3. **Database connection issues**
   - Verify the database is running: `docker-compose -f docker-compose.prod.yml ps`
   - Check database logs: `docker-compose -f docker-compose.prod.yml logs postgres`

## Support

For additional support, please contact the development team or open an issue in the repository.
