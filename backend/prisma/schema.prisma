generator client {
  provider        = "prisma-client-js"
  previewFeatures = []
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 Int                    @id @default(autoincrement())
  name               String
  email              String                 @unique(map: "users_email_unique")
  password           String
  isActive           Boolean                @default(true)
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  lastLogin          DateTime?
  passwordChangedAt  DateTime?
  role               Role                   @default(USER)
  currentCompanyId   String?
  deletedAt          DateTime?
  cancelAtPeriodEnd  Boolean                @default(false)
  lastPaymentAt      DateTime?
  planType           String?
  stripeCustomerId   String?                @unique
  subscriptionId     String?                @unique
  subscriptionStatus String?
  companies          CompanyMember[]
  documents          Document[]
  inventoryHistory   InventoryHistory[]
  inventoryItems     InventoryItem[]        @relation("CreatedBy")
  reports            ReconciliationReport[]
  refreshTokens      RefreshToken[]
  userFeatures        UserFeature[]
  currentCompany     Company?               @relation("UserCurrentCompany", fields: [currentCompanyId], references: [id])

  @@index([role])
  @@index([isActive])
  @@index([currentCompanyId])
  @@map("users")
}

model UserFeature {
  id          Int      @id @default(autoincrement())
  userId      Int
  featureName String
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, featureName])
  @@index([userId])
  @@index([featureName])
  @@map("user_features")
}

model RoleFeature {
  id          Int      @id @default(autoincrement())
  role        Role
  featureName String
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([role, featureName])
  @@index([role])
  @@index([featureName])
  @@map("role_features")
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tokenHash String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model ReconciliationReport {
  id        Int      @id @default(autoincrement())
  title     String
  amount    Float
  userId    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])

  @@unique([title, userId], name: "title_userId")
  @@index([userId])
  @@index([createdAt])
  @@map("reconciliation_reports")
}

model Category {
  id          Int             @id @default(autoincrement())
  name        String          @unique
  description String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  deletedAt   DateTime?
  items       InventoryItem[]

  @@index([name])
  @@map("categories")
}

model Supplier {
  id        Int             @id @default(autoincrement())
  name      String
  email     String?
  phone     String?
  address   String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  deletedAt DateTime?
  items     InventoryItem[]

  @@index([name])
  @@index([email])
  @@map("suppliers")
}

model InventoryItem {
  id           String             @id @default(uuid())
  name         String
  description  String?
  sku          String             @unique
  barcode      String?            @unique
  categoryId   Int?
  supplierId   Int?
  quantity     Int                @default(0)
  unit         String
  costPrice    Decimal            @default(0)
  sellingPrice Decimal            @default(0)
  reorderPoint Int                @default(0)
  location     String?
  notes        String?
  isActive     Boolean            @default(true)
  tenantId     String
  createdById  Int
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  deletedAt    DateTime?
  history      InventoryHistory[]
  category     Category?          @relation(fields: [categoryId], references: [id])
  createdBy    User               @relation("CreatedBy", fields: [createdById], references: [id])
  supplier     Supplier?          @relation(fields: [supplierId], references: [id])

  @@index([sku])
  @@index([barcode])
  @@index([categoryId])
  @@index([supplierId])
  @@index([tenantId])
  @@index([isActive])
  @@map("inventory_items")
}

model InventoryHistory {
  id               Int                  @id @default(autoincrement())
  itemId           String
  quantity         Int
  previousQuantity Int
  type             InventoryHistoryType
  referenceId      String?
  notes            String?
  createdById      Int
  createdAt        DateTime             @default(now())
  createdBy        User                 @relation(fields: [createdById], references: [id])
  item             InventoryItem        @relation(fields: [itemId], references: [id])

  @@index([itemId])
  @@index([type])
  @@index([referenceId])
  @@index([createdAt])
  @@map("inventory_history")
}

model Company {
  id           String          @id @default(uuid())
  name         String
  description  String?
  logo         String?
  website      String?
  isActive     Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  deletedAt    DateTime?
  accounts     Account[]
  clients      Client[]
  members      CompanyMember[]
  invoices     Invoice[]
  transactions Transaction[]
  currentUsers User[]          @relation("UserCurrentCompany")

  @@index([name])
  @@index([isActive])
  @@map("companies")
}

model CompanyMember {
  id        String   @id @default(uuid())
  companyId String
  userId    Int
  role      String   @default("MEMBER")
  joinedAt  DateTime @default(now())
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([companyId, userId])
  @@index([userId])
  @@index([role])
  @@map("company_members")
}

model Account {
  id               String            @id @default(uuid())
  companyId        String
  code             String
  name             String
  type             AccountType
  parentId         String?
  balance          Decimal           @default(0)
  description      String?
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  deletedAt        DateTime?
  company          Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  parent           Account?          @relation("AccountHierarchy", fields: [parentId], references: [id])
  children         Account[]         @relation("AccountHierarchy")
  invoiceItems     InvoiceItem[]
  transactionLines TransactionLine[]

  @@unique([companyId, code])
  @@index([companyId])
  @@index([type])
  @@index([parentId])
  @@index([isActive])
  @@index([name])
  @@map("accounts")
}

model Transaction {
  id                String            @id @default(uuid())
  transactionNumber String            @unique
  date              DateTime
  type              TransactionType
  totalAmount       Decimal
  description       String?
  companyId         String
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  lines             TransactionLine[]
  company           Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([date])
  @@index([type])
  @@index([transactionNumber])
  @@map("transactions")
}

model TransactionLine {
  id            String      @id @default(uuid())
  transactionId String
  accountId     String
  debit         Decimal     @default(0)
  credit        Decimal     @default(0)
  description   String?
  account       Account     @relation(fields: [accountId], references: [id])
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([transactionId])
  @@index([accountId])
  @@map("transaction_lines")
}

model Invoice {
  id            String        @id @default(uuid())
  invoiceNumber String        @unique
  date          DateTime
  dueDate       DateTime
  totalAmount   Decimal
  status        InvoiceStatus @default(DRAFT)
  companyId     String
  clientId      String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  items         InvoiceItem[]
  client        Client?       @relation(fields: [clientId], references: [id])
  company       Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([status])
  @@index([date])
  @@map("invoices")
}

model InvoiceItem {
  id          String  @id @default(uuid())
  invoiceId   String
  description String
  quantity    Decimal
  unitPrice   Decimal
  totalAmount Decimal
  accountId   String
  account     Account @relation(fields: [accountId], references: [id])
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([accountId])
  @@map("invoice_items")
}

model Client {
  id        String    @id @default(uuid())
  name      String
  email     String?
  phone     String?
  address   String?
  companyId String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  company   Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invoices  Invoice[]

  @@index([companyId])
  @@map("clients")
}

model Activity {
  id          String   @id @default(uuid())
  type        String
  action      String
  userId      String
  userName    String
  description String
  metadata    Json?
  timestamp   DateTime @default(now())

  @@map("activities")
}

model ActivityNotification {
  id         String   @id @default(uuid())
  userId     String
  activityId String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@map("activity_notifications")
}

model ActivityAggregation {
  id           String   @id @default(uuid())
  userId       String
  activityType String
  count        Int      @default(0)
  lastActivity DateTime @default(now())

  @@map("activity_aggregations")
}

model NotificationPreference {
  id      String  @id @default(uuid())
  userId  String
  type    String
  enabled Boolean @default(true)

  @@map("notification_preferences")
}

model ActivityStream {
  id        String   @id @default(uuid())
  userId    String
  event     String
  data      Json?
  timestamp DateTime @default(now())
  processed Boolean  @default(false)

  @@map("activity_streams")
}

model Customer {
  id                 String   @id @default(uuid())
  companyName        String?
  firstName          String?
  lastName           String?
  email              String?  @unique
  phone              String?
  address            Json?
  province           String?
  country            String?
  defaultTaxSettings Json?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@map("customers")
}

model Product {
  id           String   @id @default(uuid())
  sku          String   @unique
  name         String
  description  String?
  unitPrice    Int
  taxInclusive Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("products")
}

model Payment {
  id             String        @id @default(uuid())
  invoiceId      String
  amount         Int
  method         PaymentMethod
  transactionRef String?
  paidAt         DateTime      @default(now())
  metadata       Json?

  @@map("payments")
}

model AccountEntry {
  id            String   @id @default(uuid())
  refId         String
  refType       String
  debitAccount  String
  creditAccount String
  amount        Int
  description   String
  createdAt     DateTime @default(now())

  @@map("account_entries")
}

model Document {
  id           String           @id @default(uuid())
  userId       Int
  fileName     String
  originalName String
  mimeType     String
  size         Int
  category     DocumentCategory
  filePath     String
  description  String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("documents")
}

model TaxRule {
  id         String   @id @default(uuid())
  name       String
  regionCode String
  rate       Float
  isCompound Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@map("tax_rules")
}

enum Role {
  USER
  ADMIN
  MANAGER
  AUDITOR
  INVENTORY_MANAGER
}

enum InventoryHistoryType {
  INITIAL
  RECEIVED
  SOLD
  ADJUSTMENT
  RETURNED
  DAMAGED
  DELETED
  TRANSFER_IN
  TRANSFER_OUT
}

enum TransactionType {
  JOURNAL_ENTRY
  INVOICE
  PAYMENT
  BILL
  EXPENSE
  ADJUSTMENT
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  BANK_TRANSFER
  CHECK
  ONLINE
}

enum DocumentCategory {
  INVOICE
  RECEIPT
  CONTRACT
  OTHER
}
