const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

function fixEnvironmentConfig() {
  console.log('ðŸ”§ Fixing Environment & Configuration Issues\n');
  
  let fixesApplied = [];
  
  // 1. Fix .gitignore
  console.log('ðŸš« Fixing .gitignore...');
  
  const gitignoreContent = `# Dependencies
node_modules/
.pnp
.pnp.js

# Production builds
dist/
build/
.next/

# Environment variables
.env
.env.local
.env.development.local
.env.test.local
.env.production.local

# Debug logs
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

# Runtime data
pids
*.pid
*.seed
*.pid.lock

# Coverage directory used by tools like istanbul
coverage/
*.lcov

# nyc test coverage
.nyc_output

# Dependency directories
node_modules/
jspm_packages/

# TypeScript cache
*.tsbuildinfo

# Optional npm cache directory
.npm

# Optional eslint cache
.eslintcache

# Microbundle cache
.rpt2_cache/
.rts2_cache_cjs/
.rts2_cache_es/
.rts2_cache_umd/

# Optional REPL history
.node_repl_history

# Output of 'npm pack'
*.tgz

# Yarn Integrity file
.yarn-integrity

# dotenv environment variables file
.env
.env.test

# parcel-bundler cache (https://parceljs.org/)
.cache
.parcel-cache

# Next.js build output
.next

# Nuxt.js build / generate output
.nuxt

# Gatsby files
.cache/
public

# Storybook build outputs
storybook-static/

# Temporary folders
tmp/
temp/

# Logs
logs
*.log

# Runtime data
pids
*.pid
*.seed

# Directory for instrumented libs generated by jscoverage/JSCover
lib-cov

# Coverage directory used by tools like istanbul
coverage

# Grunt intermediate storage (https://gruntjs.com/creating-plugins#storing-task-files)
.grunt

# Bower dependency directory (https://bower.io/)
bower_components

# node-waf configuration
.lock-wscript

# Compiled binary addons (https://nodejs.org/api/addons.html)
build/Release

# Dependency directories
node_modules/
jspm_packages/

# TypeScript v1 declaration files
typings/

# Optional npm cache directory
.npm

# Optional eslint cache
.eslintcache

# Optional REPL history
.node_repl_history

# Output of 'npm pack'
*.tgz

# Yarn Integrity file
.yarn-integrity

# dotenv environment variables file
.env

# parcel-bundler cache (https://parceljs.org/)
.cache
.parcel-cache

# next.js build output
.next

# nuxt.js build output
.nuxt

# vuepress build output
.vuepress/dist

# Serverless directories
.serverless

# FuseBox cache
.fusebox/

# DynamoDB Local files
.dynamodb/

# TernJS port file
.tern-port

# Stores VSCode versions used for testing VSCode extensions
.vscode-test

# System files
.DS_Store
Thumbs.db

# IDE files
.vscode/
.idea/
*.swp
*.swo
*~

# Test files
test-results/
playwright-report/
test-results.xml
`;
  
  fs.writeFileSync('.gitignore', gitignoreContent);
  fixesApplied.push('Updated .gitignore with comprehensive ignore patterns');
  
  // 2. Create missing environment files
  console.log('\nðŸ“ Creating Missing Environment Files...');
  
  // Create .env.production
  const envProductionContent = `# Production Environment Variables
NODE_ENV=production
VITE_API_URL=https://api.accubooks.com
VITE_APP_URL=https://accubooks.com
VITE_WS_URL=wss://api.accubooks.com
VITE_SENTRY_DSN=your_sentry_dsn_here
VITE_GOOGLE_ANALYTICS_ID=your_ga_id_here
VITE_STRIPE_PUBLISHABLE_KEY=your_stripe_key_here
VITE_ENABLE_ANALYTICS=true
VITE_LOG_LEVEL=error
`;
  
  if (!fs.existsSync('.env.production')) {
    fs.writeFileSync('.env.production', envProductionContent);
    fixesApplied.push('Created .env.production file');
  }
  
  // Create .env.development
  const envDevelopmentContent = `# Development Environment Variables
NODE_ENV=development
VITE_API_URL=http://localhost:3001
VITE_APP_URL=http://localhost:3000
VITE_WS_URL=ws://localhost:3001
VITE_SENTRY_DSN=
VITE_GOOGLE_ANALYTICS_ID=
VITE_STRIPE_PUBLISHABLE_KEY=pk_test_your_test_key_here
VITE_ENABLE_ANALYTICS=false
VITE_LOG_LEVEL=debug
VITE_HOT_RELOAD=true
`;
  
  if (!fs.existsSync('.env.development')) {
    fs.writeFileSync('.env.development', envDevelopmentContent);
    fixesApplied.push('Created .env.development file');
  }
  
  // Fix .env.local
  const envLocalContent = `# Local Environment Variables (overrides all others)
NODE_ENV=development
VITE_API_URL=http://localhost:3001
VITE_APP_URL=http://localhost:3000
VITE_WS_URL=ws://localhost:3001
VITE_ENABLE_ANALYTICS=false
VITE_LOG_LEVEL=debug
VITE_DEV_TOOLS=true
`;
  
  fs.writeFileSync('.env.local', envLocalContent);
  fixesApplied.push('Updated .env.local with proper variables');
  
  // 3. Fix TypeScript configurations
  console.log('\nðŸ“˜ Fixing TypeScript Configurations...');
  
  // Fix tsconfig.node.json
  const tsconfigNodeContent = {
    "compilerOptions": {
      "target": "ES2020",
      "lib": ["ES2020"],
      "module": "ESNext",
      "moduleResolution": "node",
      "allowSyntheticDefaultImports": true,
      "esModuleInterop": true,
      "skipLibCheck": true,
      "strict": false,
      "types": ["node"]
    },
    "include": [
      "vite.config.ts",
      "scripts/**/*"
    ]
  };
  
  fs.writeFileSync('tsconfig.node.json', JSON.stringify(tsconfigNodeContent, null, 2));
  fixesApplied.push('Fixed tsconfig.node.json');
  
  // Fix tsconfig.eslint.json
  const tsconfigESLintContent = {
    "compilerOptions": {
      "target": "ES2020",
      "module": "ESNext",
      "moduleResolution": "node",
      "allowSyntheticDefaultImports": true,
      "esModuleInterop": true,
      "skipLibCheck": true,
      "strict": false
    },
    "include": [
      "src/**/*",
      "scripts/**/*"
    ]
  };
  
  fs.writeFileSync('tsconfig.eslint.json', JSON.stringify(tsconfigESLintContent, null, 2));
  fixesApplied.push('Fixed tsconfig.eslint.json');
  
  // 4. Remove duplicate vite.config.js (keep vite.config.ts)
  console.log('\nâš¡ Fixing Vite Configuration...');
  
  if (fs.existsSync('vite.config.js')) {
    fs.unlinkSync('vite.config.js');
    fixesApplied.push('Removed duplicate vite.config.js (keeping vite.config.ts)');
  }
  
  // 5. Fix hardcoded values in source files
  console.log('\nðŸ” Fixing Hardcoded Values...');
  
  const sourceFiles = getSourceFiles('src');
  let filesFixed = 0;
  
  sourceFiles.forEach(file => {
    try {
      let content = fs.readFileSync(file, 'utf8');
      let modified = false;
      
      // Replace localhost URLs with environment variables
      content = content.replace(/http:\/\/localhost:3000/g, 'import.meta.env.VITE_APP_URL');
      content = content.replace(/http:\/\/localhost:3001/g, 'import.meta.env.VITE_API_URL');
      content = content.replace(/ws:\/\/localhost:3001/g, 'import.meta.env.VITE_WS_URL');
      
      // Replace common hardcoded patterns
      content = content.replace(/'development'/g, 'import.meta.env.MODE');
      content = content.replace(/"development"/g, 'import.meta.env.MODE');
      
      if (content !== fs.readFileSync(file, 'utf8')) {
        fs.writeFileSync(file, content);
        modified = true;
        filesFixed++;
      }
      
    } catch (error) {
      // Skip files that can't be read
    }
  });
  
  if (filesFixed > 0) {
    fixesApplied.push(`Fixed hardcoded values in ${filesFixed} source files`);
  }
  
  // 6. Update .env and .env.example to remove placeholders
  console.log('\nðŸ“ Updating Environment Templates...');
  
  const envContent = `# Environment Variables
NODE_ENV=development
VITE_API_URL=http://localhost:3001
VITE_APP_URL=http://localhost:3000
VITE_WS_URL=ws://localhost:3001
VITE_SENTRY_DSN=
VITE_GOOGLE_ANALYTICS_ID=
VITE_STRIPE_PUBLISHABLE_KEY=pk_test_your_test_key_here
VITE_ENABLE_ANALYTICS=false
VITE_LOG_LEVEL=debug
VITE_HOT_RELOAD=true
`;
  
  fs.writeFileSync('.env', envContent);
  fixesApplied.push('Updated .env with proper values');
  
  const envExampleContent = `# Environment Variables Example
NODE_ENV=development
VITE_API_URL=http://localhost:3001
VITE_APP_URL=http://localhost:3000
VITE_WS_URL=ws://localhost:3001
VITE_SENTRY_DSN=your_sentry_dsn_here
VITE_GOOGLE_ANALYTICS_ID=your_ga_id_here
VITE_STRIPE_PUBLISHABLE_KEY=your_stripe_key_here
VITE_ENABLE_ANALYTICS=false
VITE_LOG_LEVEL=debug
VITE_HOT_RELOAD=true
`;
  
  fs.writeFileSync('.env.example', envExampleContent);
  fixesApplied.push('Updated .env.example with proper template');
  
  // 7. Test TypeScript compilation
  console.log('\nðŸ§ª Testing TypeScript Compilation...');
  
  try {
    const result = execSync('npx tsc --noEmit --skipLibCheck', { 
      encoding: 'utf8', 
      cwd: process.cwd(),
      stdio: 'pipe'
    });
    
    console.log('âœ… TypeScript compilation successful');
    fixesApplied.push('TypeScript compilation now works');
    
  } catch (error) {
    console.log('âš ï¸  TypeScript compilation still has issues');
  }
  
  // 8. Summary
  console.log('\nðŸ“Š Environment Configuration Fix Summary:');
  console.log(`  ðŸ”§ Fixes Applied: ${fixesApplied.length}`);
  
  if (fixesApplied.length > 0) {
    console.log('\nâœ… Fixes Applied:');
    fixesApplied.forEach(fix => console.log(`  - ${fix}`));
  }
  
  return {
    success: true,
    fixesApplied,
    filesFixed
  };
}

// Helper function to get all source files
function getSourceFiles(dir) {
  const files = [];
  
  function traverse(currentDir) {
    try {
      const items = fs.readdirSync(currentDir);
      
      for (const item of items) {
        const fullPath = path.join(currentDir, item);
        const stat = fs.statSync(fullPath);
        
        if (stat.isDirectory() && !item.startsWith('.') && item !== 'node_modules') {
          traverse(fullPath);
        } else if (stat.isFile() && (item.endsWith('.ts') || item.endsWith('.tsx'))) {
          files.push(fullPath);
        }
      }
    } catch (error) {
      // Skip directories we can't read
    }
  }
  
  traverse(dir);
  return files;
}

if (require.main === module) {
  fixEnvironmentConfig();
}

module.exports = { fixEnvironmentConfig };
