#!/bin/bash

# AccuBooks Production Deployment Verification Script
# Run this script after deployment to verify everything is working correctly

echo "üöÄ Starting AccuBooks Production Deployment Verification..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

VERIFICATION_ITEMS=0
PASSED_ITEMS=0

# Function to print status
print_status() {
    VERIFICATION_ITEMS=$((VERIFICATION_ITEMS + 1))
    if [ $2 -eq 0 ]; then
        echo -e "${GREEN}‚úì $1${NC}"
        PASSED_ITEMS=$((PASSED_ITEMS + 1))
    else
        echo -e "${RED}‚úó $1${NC}"
    fi
}

# Function to print info
print_info() {
    echo -e "${BLUE}‚Ñπ $1${NC}"
}

# Function to print warning
print_warning() {
    echo -e "${YELLOW}‚ö† $1${NC}"
}

# Check if required tools are installed
check_dependencies() {
    print_info "Checking dependencies..."

    if command -v curl &> /dev/null; then
        print_status "curl is installed" 0
    else
        print_status "curl is installed" 1
    fi

    if command -v docker &> /dev/null; then
        print_status "Docker is installed" 0
    else
        print_status "Docker is installed" 1
    fi

    if command -v docker-compose &> /dev/null; then
        print_status "Docker Compose is installed" 0
    else
        print_status "Docker Compose is installed" 1
    fi
}

# Check environment configuration
check_environment() {
    print_info "Checking environment configuration..."

    if [ -f ".env.production" ]; then
        print_status "Production environment file exists" 0

        # Check for required variables
        if grep -q "DATABASE_URL=" .env.production; then
            print_status "Database URL is configured" 0
        else
            print_status "Database URL is configured" 1
        fi

        if grep -q "JWT_SECRET=" .env.production; then
            print_status "JWT secret is configured" 0
        else
            print_status "JWT secret is configured" 1
        fi

        if grep -q "DOMAIN=" .env.production; then
            print_status "Domain is configured" 0
        else
            print_status "Domain is configured" 1
        fi
    else
        print_status "Production environment file exists" 1
    fi
}

# Check Docker services
check_docker_services() {
    print_info "Checking Docker services..."

    if docker-compose -f docker-compose.prod.yml ps | grep -q "Up"; then
        print_status "Docker services are running" 0

        # Check specific services
        SERVICES=("postgres" "redis" "app" "nginx")
        for service in "${SERVICES[@]}"; do
            if docker-compose -f docker-compose.prod.yml ps | grep -q "$service.*Up"; then
                print_status "Service $service is running" 0
            else
                print_status "Service $service is running" 1
            fi
        done
    else
        print_status "Docker services are running" 1
    fi
}

# Check application health
check_application_health() {
    print_info "Checking application health..."

    # Get domain from environment file
    DOMAIN=$(grep "DOMAIN=" .env.production | cut -d'=' -f2 2>/dev/null || echo "localhost")

    # Check main health endpoint
    if curl -f -s "https://$DOMAIN/health" > /dev/null 2>&1; then
        print_status "Application health endpoint is accessible" 0
    else
        print_status "Application health endpoint is accessible" 1
    fi

    # Check API endpoint
    if curl -f -s -H "Authorization: Bearer test" "https://$DOMAIN/api/companies" > /dev/null 2>&1; then
        print_status "API endpoint is accessible" 0
    else
        print_status "API endpoint is accessible" 1
    fi
}

# Check SSL certificate
check_ssl_certificate() {
    print_info "Checking SSL certificate..."

    DOMAIN=$(grep "DOMAIN=" .env.production | cut -d'=' -f2 2>/dev/null || echo "localhost")

    if curl -f -s -I "https://$DOMAIN" 2>/dev/null | grep -q "HTTP/2"; then
        print_status "SSL certificate is valid" 0
    else
        print_status "SSL certificate is valid" 1
    fi
}

# Check database connectivity
check_database() {
    print_info "Checking database connectivity..."

    if docker-compose -f docker-compose.prod.yml exec postgres pg_isready -U accubooks_prod > /dev/null 2>&1; then
        print_status "Database is accessible" 0

        # Check if database has data
        TABLE_COUNT=$(docker-compose -f docker-compose.prod.yml exec postgres psql -U accubooks_prod -d accubooks_prod -t -c "SELECT count(*) FROM information_schema.tables WHERE table_schema = 'public';" 2>/dev/null || echo "0")
        if [ "$TABLE_COUNT" -gt 0 ]; then
            print_status "Database contains tables" 0
        else
            print_status "Database contains tables" 1
        fi
    else
        print_status "Database is accessible" 1
    fi
}

# Check Redis connectivity
check_redis() {
    print_info "Checking Redis connectivity..."

    if docker-compose -f docker-compose.prod.yml exec redis redis-cli ping > /dev/null 2>&1; then
        print_status "Redis is accessible" 0
    else
        print_status "Redis is accessible" 1
    fi
}

# Check monitoring services
check_monitoring() {
    print_info "Checking monitoring services..."

    # Check Prometheus
    if curl -f -s "http://localhost:9090/-/healthy" > /dev/null 2>&1; then
        print_status "Prometheus is running" 0
    else
        print_status "Prometheus is running" 1
    fi

    # Check Grafana
    if curl -f -s "http://localhost:3000/api/health" > /dev/null 2>&1; then
        print_status "Grafana is running" 0
    else
        print_status "Grafana is running" 1
    fi
}

# Check background jobs
check_background_jobs() {
    print_info "Checking background jobs..."

    if docker-compose -f docker-compose.prod.yml exec app curl -f -s "http://localhost:5000/api/jobs/queues" > /dev/null 2>&1; then
        print_status "Background job API is accessible" 0
    else
        print_status "Background job API is accessible" 1
    fi
}

# Check third-party integrations
check_integrations() {
    print_info "Checking third-party integrations..."

    # Check Stripe (basic connectivity test)
    if curl -f -s "https://api.stripe.com/v1/charges" -H "Authorization: Bearer sk_test_..." > /dev/null 2>&1; then
        print_status "Stripe API is accessible" 0
    else
        print_warning "Stripe API connectivity test failed (may need valid API key)"
    fi

    # Check Plaid (basic connectivity test)
    if curl -f -s "https://sandbox.plaid.com/" > /dev/null 2>&1; then
        print_status "Plaid API is accessible" 0
    else
        print_warning "Plaid API connectivity test failed"
    fi
}

# Check security configurations
check_security() {
    print_info "Checking security configurations..."

    # Check SSL/TLS
    DOMAIN=$(grep "DOMAIN=" .env.production | cut -d'=' -f2 2>/dev/null || echo "localhost")
    if curl -f -s -I "https://$DOMAIN" 2>/dev/null | grep -q "Strict-Transport-Security"; then
        print_status "HSTS security headers are present" 0
    else
        print_status "HSTS security headers are present" 1
    fi

    # Check for security headers
    if curl -f -s -I "https://$DOMAIN" 2>/dev/null | grep -q "X-Frame-Options"; then
        print_status "X-Frame-Options header is present" 0
    else
        print_status "X-Frame-Options header is present" 1
    fi
}

# Main verification flow
main() {
    echo "üîç AccuBooks Production Deployment Verification"
    echo "=============================================="

    check_dependencies
    echo ""

    check_environment
    echo ""

    check_docker_services
    echo ""

    check_application_health
    echo ""

    check_ssl_certificate
    echo ""

    check_database
    echo ""

    check_redis
    echo ""

    check_monitoring
    echo ""

    check_background_jobs
    echo ""

    check_integrations
    echo ""

    check_security
    echo ""

    # Final summary
    echo "üìä Verification Summary:"
    echo "========================="
    echo "Total checks: $VERIFICATION_ITEMS"
    echo "Passed: $PASSED_ITEMS"
    echo "Failed: $((VERIFICATION_ITEMS - PASSED_ITEMS))"

    if [ $PASSED_ITEMS -eq $VERIFICATION_ITEMS ]; then
        echo -e "${GREEN}üéâ All verification checks passed!${NC}"
        echo ""
        echo "‚úÖ AccuBooks is ready for production use!"
        echo ""
        echo "üåê Access your application at: https://$DOMAIN"
        echo "üìä Monitoring dashboard: http://your-server-ip:3000"
        echo "üìö API documentation: https://$DOMAIN/api/docs"
        exit 0
    else
        echo -e "${RED}‚ùå Some verification checks failed.${NC}"
        echo ""
        echo "üîß Please address the failed checks before going live."
        echo ""
        echo "üí° Run this script again after fixing the issues."
        exit 1
    fi
}

# Run the verification
main
